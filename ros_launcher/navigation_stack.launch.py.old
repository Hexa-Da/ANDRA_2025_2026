# navigation_stack.launch.py
from launch import LaunchDescription
from launch_ros.actions import Node
from launch.actions import DeclareLaunchArgument, ExecuteProcess
from launch.substitutions import LaunchConfiguration
from launch.conditions import IfCondition, UnlessCondition

def generate_launch_description():
    # Launch arguments
    use_slam = LaunchConfiguration('use_slam', default='true')
    use_amcl = LaunchConfiguration('use_amcl', default='false')
    map_path = LaunchConfiguration('map_path', default='')
    
    return LaunchDescription([
        # Launch arguments
        DeclareLaunchArgument('use_slam', default_value='true'),
        DeclareLaunchArgument('use_amcl', default_value='false'),
        DeclareLaunchArgument('map_path', default_value=''),
        
        # Static transform publisher for base_link to zed_camera_link

        ExecuteProcess(
            cmd=['ros2', 'launch', 'ydlidar_ros2_driver', 'ydlidar_launch.py'],
            output='screen',
        ),

        ExecuteProcess(
            cmd=['ros2', 'launch', 'scout_base', 'scout_mini_base.launch.py'],
            output='screen',
        ),

        ExecuteProcess(
            cmd=['ros2', 'launch', 'zed_wrapper', 'zed_camera.launch.py', 'camera_model:=zed2'],
            output='screen',
        ),

        ExecuteProcess(
            cmd=['ros2', 'run', 'image_transfer', 'image_subscriber'],
            output='screen',
        ),

        ExecuteProcess(
            cmd=['ros2', 'run', 'image_transfer', 'image_publisher'],
            output='screen',
        ),

        ExecuteProcess(
            cmd=['ros2', 'run', 'image_transfer', 'position_publisher'],
            output='screen',
        ),

        Node(
            package='tf2_ros',
            executable='static_transform_publisher',
            name='base_to_zed_tf',
            arguments=['0', '0', '0', '0', '0', '0', 'base_link', 'zed_camera_link']
        ),
        
        # Static transform publisher for base_link to laser_frame
        Node(
            package='tf2_ros',
            executable='static_transform_publisher',
            name='base_to_laser_tf',
            arguments=['0', '0', '0', '1.5707', '0', '0', 'base_link', 'laser_frame']
        ),
        
        # Robot localization node
        Node(
            package='robot_localization',
            executable='ekf_node',
            name='ekf_filter_node',
            parameters=['ekf_config.yaml']
        ),
        
        # SLAM Toolbox (mapping mode)
        Node(
            package='slam_toolbox',
            executable='sync_slam_toolbox_node',
            name='slam_toolbox',
            parameters=['slam_config.yaml'],
            condition=IfCondition(use_slam)
        ),
        
        # AMCL (localization mode)
        Node(
            package='nav2_amcl',
            executable='amcl',
            name='amcl',
            parameters=['amcl_config.yaml', {'map': map_path}],
            condition=IfCondition(use_amcl)
        ),
        
        # Map server (when using AMCL)
        Node(
            package='nav2_map_server',
            executable='map_server',
            name='map_server',
            parameters=[{'yaml_filename': map_path}],
            condition=IfCondition(use_amcl)
        )
    ])
